package main

import "encoding/binary"

const (
	C0 uint64 = 0xC3A5C85C97CB3127
	C1 uint64 = 0xB492B66FBE98F273
	C2 uint64 = 0x9AE16A3B2F90404F
	C3 uint64 = 0xA4093822299F31D0
	C4 uint64 = 0x243F6A8885A308D3
)

var TBL = [...]uint64{
	0x243F6A8885A308D3, 0x13198A2E03707344, 0xA4093822299F31D0, 0x082EFA98EC4E6C89,
	0x452821E638D01377, 0xBE5466CF34E90C6C, 0xC0AC29B7C97C50DD, 0x3F84D5B5B5470917,
	0x9216D5D98979FB1B, 0xD1310BA698DFB5AC, 0x2FFD72DBD01ADFB7, 0xB8E1AFED6A267E96,
	0xBA7C9045F12C7F99, 0x24A19947B3916CF7, 0x0801F2E2858EFC16, 0x636920D871574E69,
	0x2C8E3CD6EC53395A, 0xD33C637E87F9B583, 0x255157D9C1E6C7D2, 0xC39A5AE5D252A25C,
	0xD1C0332EADB54414, 0x0370D26E1B706043, 0x1B82569D7C037258, 0xC00203CC96B79E0F,
	0xB96D64BB4E4D39F2, 0x2D8C29E7D3C29146, 0x47B206A2FBB795AA, 0x59EF0C0E9529A463,
	0x32D28D6923DBE93A, 0x19B8C02805175215, 0x718D93CD6923F37B, 0xE259CB3E96433931,
	0xFEB977ED7159717E, 0x5BC89C73AEF8CBFB, 0x5C507604F593D047, 0x3247D2446734D163,
	0x9EF05EB2C4942339, 0x291DE7C463C50C9E, 0x26D0A50A144F7595, 0x3499F29C5C35D83C,
	0xE5B875474D60A208, 0xC464056D0228C847, 0x62C41BA393F56E9A, 0x2A0C27D022B29FE2,
	0xF85ACFDE8E5D732C, 0x8D97039F39B32C21, 0x97134C408EF76FFD, 0x072ED18C1A79F4FA,
	0xCF8F9A8EB3BA6E59, 0xEC6D92D1B4459C65, 0x50CC62B5D254FDF0, 0x80223ABBB74CA5BF,
	0x103838EB94396D21, 0x9D2BF883599A68AD, 0x67328F3C474E4262, 0x0522E41788E9E170,
	0x9122D95C49EC717E, 0x16F241AAA652D656, 0xA9FE33130B9BD85C, 0x9D099B69099F523A,
	0xF461C217254985A8, 0x21DC97F4BABB8ACA, 0x20EDE3DBAEABB89F, 0x739A320ADD4BB298,
	0xCE67DDACFD53541A, 0xAF5A415C39CD9E14, 0xD34C241F079CDD9A, 0xD9E634F6F8F6014F,
	0xB3DE94FFD9A5B2A8, 0xF178CE6B48C84140, 0x351E708A22300D16, 0xDE3C7A289A54A375,
	0xB796F46A970796B5, 0x097C08175C8C2F17, 0xA835350600712CE0, 0xB4E16DDF4038FA2D,
	0xA018DBE093A76FE1, 0xF4B1A39BAEEAA0D7, 0xDD641BCD61DA6404, 0x58B94BC02D6E5754,
	0x4922E60148943790, 0xABE2F898858B4807, 0xA719F991F613E8E6, 0x73F75069803BFD93,
	0xA59942889716E4C5, 0xEDEE3F1AE7D72FE4, 0x6FC7E67070C3C3A4, 0x59569B38E467CC86,
	0xDC590BCB20C0400E, 0xA5D1E5B4E4630EBE, 0x5E17C67DCC9D9D19, 0xE132B3CD9B1CDAE4,
	0xCE0CCEFBE22398E0, 0x8867A2D2A216AE47, 0x6CD7132FAA6D480A, 0xE7572973EE78E08D,
	0x3C95B7D81F0AA3CC, 0xE3F32F9FEB88691D, 0xF14BAC7FC8D416BC, 0x19DA117BAD4CA47C,
	0x68CE2A5D20D776B6, 0x3B3874D9B79948D2, 0xF387626107CA90C4, 0xA222AE2934DC7988,
	0x20F1FA2FE510B98E, 0x2E5633B17CAD7AE2, 0x459008712715760C, 0xB97C7244EE13D1AC,
	0x57418C3A4F67D71B, 0xD35D6DF0EA4EC7CF, 0x19008ECD36CF82D4, 0x99F4FF0C2E29F79F,
	0xF73B2E6DD1700249, 0x82D73DAA385AC897, 0x8A290E4A62F9CDF5, 0x8BDB80F0B308E083,
	0xCCD57CB4E82521A4, 0xC9D948C9952ABA93, 0x431F07CAC8CBF70E, 0xA31D3775A7CAE166,
	0x6673C79BC2751051, 0xBB23766FE6968E9D, 0x24F2F37467676D4B, 0xAF8DEFB20FB22F03,
	0x8F9A7BD54F7B3C67, 0x696501D950F09E14, 0x00D3E6A3D1A3D45A, 0xBB44BA45BA338D04,
	0xBEC6767E7A6DDACA, 0x57170F201621E332, 0xDCE685372C5DA40E, 0x23DA3BDF7435446A,
	0x738BF654616E61B6, 0x658E12FD964AD19B, 0x524F37E12A3D1D5C, 0xD159D3D792A07244,
	0x31025FE9AC96487F, 0x4981CF78426296EB, 0xE807CA6759D26718, 0xB6E813E440DD5F1D,
	0x1F5DD1E35F39F86C, 0x38AF09B26B534E02, 0x4110BA7C1A3D7EFD, 0x5798D1DE8450D0BA,
	0x9BD27706499DD2CE, 0xA4A3FBA200323106, 0x47A0E4BE11DC8B76, 0x6603D88568B0C340,
	0x582F2B69A851F71F, 0x3D5A4F7D2272EC80, 0x6A4CC6BDD4E47CD5, 0xAD6895ABD013A43E,
	0xDBFE412CB130CB63, 0x93CA6A9FC5C4C04F, 0xE1D39859166063A9, 0x93F0EFD7650DFC44,
	0xEFB5231C8FABF673, 0x94DCBFA432FB991D, 0x27754BC587AEECBB, 0x5EA23DDC2075DC23,
	0xB17CE192689EC16A, 0x1D10EEC776723BB6, 0x6512F051106ADB70, 0xF6F10A556ED9BB84,
	0xB454290229D715CC, 0x698C098FC452C043, 0x7DC6ECD60B7FE16C, 0x1B96F7E82A18CA43,
	0x7E7C7BFF60F4D80F, 0xA2A89C98556634E7, 0x4F07DC485552D7C1, 0x34096CBD1AC5189F,
	0xBF2C4A93D11F6C46, 0x23BB48EC3A169FB1, 0x9E984BAFD380A578, 0x9A24B768077B52DF,
	0x09B7056894741E6C, 0xCF1C91B9A3D2A42D, 0x5EF74C85DC1E5F7D, 0x44A4629AA6A9133D,
	0x2310D7C00A471057, 0xEFF6521AD2254BE5, 0x98C92A461AAA64DD, 0xD055BA2BAFE5CA18,
	0x4D617C0697C31B75, 0x56A945CEF198E29C, 0x2C6ABF4AAE163A73, 0xF22532DA891BCEC5,
	0xC3352002238D7A32, 0xF0A717A05DDBB5AC, 0x9BA1768B096C444B, 0x771E67F190C479F5,
	0xB3CE56C19CB18092, 0x4E3CAB3FEC445268, 0xDDD6F246234CB7BB, 0x7AE3BB0ADC6B473E,
	0x0DDF339FF293C816, 0xDCD7D94E64C01B6D, 0x010E8F65E7A91BDA, 0xE089572F4D3F8E8F,
	0x4E3F272C1E5505FC, 0x0841AB4BDCCA3C7F, 0x9345620EF1FE8C80, 0xEA6C4B5100FF8E2E,
	0x3235678F27383BE3, 0x5C2F1D6FB1DFC6ED, 0x15AE66A8EF88D54E, 0xDECF9939ACD7F8C5,
	0x6088747C96AAE5C6, 0x649FAE0D39683E13, 0x94C14F525EB41293, 0x553026C38110F30A,
	0x870B71CCA4A37697, 0x8AC22D0D23652B20, 0x55E45ABBB26B9621, 0xDE5CBC05EA22E9C6,
	0x2E2ADB47BD733959, 0x5C21D94A09C952E5, 0x34866F4F551D8EEB, 0x7FF50782438F3276,
	0x625C3BD0F4A5CC32, 0x6896F0018B776AD5, 0x26DE6B53EA80CF79, 0xB5AE4938B67841DF,
	0x9C3A6BF93E232334, 0xB6C501DADF2EFB64, 0xFF42338682C740F2, 0xE58CC4CFE74BAFDA,
	0xDBB9D0A2BB3BAFAB, 0x3AF098985F47817E, 0xD5A6A47BC2C446BC, 0x5EC3FDFC4D549FE1,
	0x86FAC21322913C6A, 0x10DDC6FA9F9DDBEF, 0x3562CBD2F82BC51F, 0x471631C7CD002A69,
	0xBB3F6275A3EADBFB, 0xEF75E385DB9774A0, 0x709B05ED216A537B, 0x01FB3D9EDDF350C3,
	0x5BF24EBBC1F6FD15, 0x7E2C9782A0F5A957, 0x5FA91DFA3175205D, 0x1BCE331F52E3C493,
	0x35E8D1758E647B8B, 0xAEE376783453CC8A, 0xAE7D4B1F7A26517C, 0xB77628F9D68C1E44,
	0x3E6B38F9839FB476, 0x9131E383E8D7D8A5, 0x7528E8E0C1D54B1F, 0x5728A120CC6D6D09,
	0x7332F34D34129CEB, 0xE9C79CF5502DBA8D, 0xF663E7C0F24FE931, 0x48EF8ACFBD39E77D,
}

func rol(x uint64, s uint) uint64 {
	s &= 63
	return (x << s) | (x >> (64 - s))
}

func mix1(a, b uint64) uint64 {
	x := (a ^ rol(b, 13)) + (b ^ rol(a, 7))
	x ^= x >> 23
	x = x * (C1 | 1)
	return x
}

func mix2(a, b, c uint64) uint64 {
	x := a * (b | 1)
	x ^= rol(c, uint(b&63))
	x += TBL[(a^b^c)&0xFF]
	x = (x << 31) ^ (x >> 33)
	return x
}

func obfHash(data []byte) []byte {
	var s0 = C0 ^ 0x0123456789ABCDEF
	var s1 = C1 ^ uint64(len(data))
	var s2 = C2
	var s3 = C3
	var s4 = C4

	i := 0
	ln := len(data)
	for i < ln {
		var a, b uint64
		take := 16
		if ln-i < 16 {
			take = ln - i
		}
		// little-endian pack up to 8 bytes into a, next up to 8 into b
		limA := take
		if limA > 8 {
			limA = 8
		}
		for j := 0; j < limA; j++ {
			a |= uint64(data[i+j]) << (uint(j) * 8)
		}
		if take > 8 {
			for j := 0; j < take-8; j++ {
				b |= uint64(data[i+8+j]) << (uint(j) * 8)
			}
		}

		idx := byte((a ^ b ^ s1) & 0xFF)
		tblv := TBL[idx]

		s0 = mix1(s0+a+tblv, s1^rol(b+s2, uint(a&63)))
		s1 = mix2(s1+b, s0^tblv, s3)

		if ((a ^ s0) & 0xF) < 6 {
			s2 ^= rol(tblv+s1, 17)
			s3 = s3 + ((a * 0x9E3779B97F4A7C15) ^ b)
		} else {
			s3 ^= mix1(s3, s2+a)
			s2 = s2 + rol(b^tblv, 11)
		}

		tmp := s4
		s4 = rol(s3, 23)
		s3 = rol(s2, 19)
		s2 = rol(s1, 29)
		s1 = rol(s0, 13)
		s0 = rol(tmp, 7)

		i += take
	}

	s0 ^= (uint64(len(data)) << 7) ^ 0xDEADBEEF
	s1 ^= (uint64(len(data)) << 13) ^ 0xCAFEBABE
	s2 ^= (uint64(len(data)) << 17) ^ 0x8BADF00D

	for r := 0; r < 64; r++ {
		a := s0 + rol(s3^TBL[(s1>>8)&0xFF], uint(r&63))
		b := s1 + rol(s4^TBL[(s2>>16)&0xFF], uint((r*3)&63))
		c := s2 ^ rol(s0+TBL[(s3>>24)&0xFF], uint((r*7)&63))
		s0 = mix1(a, b) ^ rol(c, uint(r&31))
		s1 = mix2(b, c, a) + (TBL[(s4>>32)&0xFF] ^ (uint64(r) * 0x9E3779B97F4A7C15))
		memidx := byte((s0 ^ s1 ^ s2 ^ s3 ^ s4) & 0xFF)
		s2 = s2 + TBL[memidx] ^ rol(s1, uint(s0&63))
		if (s3 & 1) == 0 {
			s3 = rol(s3^s2, uint(s4&63)) + (s0 * 0x27D4EB2F165667C5)
		} else {
			s3 = mix1(s3, s4) ^ (s2 + 0x9E3779B97F4A7C15)
		}
		s4 ^= (s0 + s1) * uint64(r+1)
	}

	outv0 := s0 ^ rol(s2, 17) ^ TBL[(s3>>8)&0xFF]
	outv1 := s1 ^ rol(s3, 31) ^ TBL[(s4>>16)&0xFF]
	outv2 := s2 ^ rol(s4, 47) ^ TBL[(s0>>24)&0xFF]
	outv3 := s3 ^ rol(s0, 11) ^ TBL[(s1>>32)&0xFF]

	out := make([]byte, 32)
	binary.LittleEndian.PutUint64(out[0:8], outv0)
	binary.LittleEndian.PutUint64(out[8:16], outv1)
	binary.LittleEndian.PutUint64(out[16:24], outv2)
	binary.LittleEndian.PutUint64(out[24:32], outv3)

	return out
}
