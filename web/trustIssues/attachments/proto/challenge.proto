syntax = "proto3";

package challenge;

option go_package = "grpc-chall/proto;challenge";

// Service surface with a lot of noise func
service SecretsService {
  rpc Ping(PingRequest) returns (PingResponse);
  rpc GetPublicInfo(PublicInfoRequest) returns (PublicInfoResponse);
  // part of the target
  rpc ListDocs(ListRequest) returns (ListResponse);
  rpc CreateDoc(CreateDocRequest) returns (DocResponse);
  rpc UpdateDoc(UpdateDocRequest) returns (DocResponse);
  rpc DeleteDoc(DeleteRequest) returns (DeleteResponse);
  // our target
  rpc GetSecret(GetSecretRequest) returns (SecretResponse);
  rpc AdminList(AdminListRequest) returns (AdminListResponse);
  rpc AdminAudit(AdminAuditRequest) returns (AdminAuditResponse);

  // login rpc, part of the target
  rpc Login(LoginRequest) returns (LoginResponse);
}

message PingRequest {
  int64 seq = 1;
  string note = 2;
}

message PingResponse {
  string pong = 1;
  int64 ts = 2;
}

message PublicInfoRequest {
  string q = 3;
  int32 page = 7;
}

message PublicInfoResponse {
  repeated string entries = 1;
  map<string,string> meta = 10;
}

message ListRequest {
  int32 page = 1;
  int32 per_page = 2;
  oneof filter {
    string by_tag = 10;
    int64 owner_id = 11;
  }
}

message ListResponse {
  repeated DocSummary items = 1;
  int32 total = 2;
}

message DocSummary {
  string id = 1;
  string title = 2;
  int64 created_unix = 50;
}

message CreateDocRequest {
  string title = 1;
  string content = 2;
  repeated string tags = 3;
  string owner = 20;
}

message UpdateDocRequest {
  string id = 1;
  oneof payload {
    string content = 10;
    string title = 11;
  }
  // tags must be OUTSIDE the oneof because 'repeated' inside oneof is invalid, i mean... ok
  repeated string tags = 12;
  string owner = 20;
}

message DocResponse {
  string id = 1;
  bool ok = 2;
}

message DeleteRequest {
  string id = 1;
  string owner = 20;
}
message DeleteResponse {
  bool ok = 1;
}

// these are the target endpoints
message GetSecretRequest {
  string resource_id = 1;
}

message SecretResponse {
  string secret = 1;
  int64 created = 20;
}

//still noise here
message AdminListRequest {
  int32 limit = 1;
  string q = 2;
}

message AdminListResponse {
  repeated string admin_items = 1;
}

message AdminAuditRequest {
  int64 from = 1;
  int64 to = 2;
  repeated string types = 10;
}

message AdminAuditResponse {
  repeated string events = 1;
}

// the login rpc

message LoginRequest {
    string username = 1;
    string password = 2;
}

message LoginResponse {
    string token = 1;
    int64 expires_in = 2;
}
